<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drone Mission Control</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    #controls {
      padding: 10px;
      background: #f9f9f9;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    #map {
      flex: 1;
      /* fill remaining space */
      width: 100%;
    }

    #controls select,
    #controls button {
      font-size: 16px;
      padding: 6px 10px;
      margin-right: 10px;
    }

    #controls button {
      font-size: 18px;
      padding: 12px 20px;
    }

    #statusText {
      margin-right: 10px;
      font-weight: bold;
      font-family: Arial, sans-serif;
    }

    .rotating-drone {
      width: 40px;
      height: 40px;
      transform-origin: center center;
      transition: transform 0.2s linear;
      display: block;
      pointer-events: none;
      image-rendering: auto;
    }
  </style>
</head>

<body>
  <div id="controls">
    <!-- Mission dropdown (populated in loadCapabilities) -->
    <select id="missionSelect">
      <option value="">-- Select Mission --</option>
    </select>

    <!-- Run button -->
    <button onclick="runMission()">Run</button>

    <!-- Status text -->
    <span id="statusText">Status: unknown</span>

    <!-- Recenter button -->
    <button onclick="recenter()">Recenter</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    const apiHost = "http://localhost:8888";

    // === Leaflet map setup ===
    let map = L.map('map').setView([37.422, -122.084], 17);
    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles © Esri' }
    ).addTo(map);

    // === Reference to the <select> ===
    const missionSelect = document.getElementById("missionSelect");
    const missionMap = {};

    // === Fetch and populate missions into the dropdown ===
    async function loadCapabilities() {
      // Show a “loading” placeholder
      missionSelect.innerHTML = '<option value="">Loading missions…</option>';

      try {
        const res = await fetch(`${apiHost}/capabilities`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const caps = JSON.parse(data.capabilities);

        // Reset to the default “select” line
        missionSelect.innerHTML = '<option value="">-- Select Mission --</option>';

        // If there are no missions, show a placeholder
        const missionArray = Array.isArray(caps.missions)
          ? caps.missions
          : Object.values(caps.missions);  // fallback for weird structures

        if (missionArray.length === 0) {
          missionSelect.innerHTML = '<option value="">(No missions found)</option>';
          return;
        }

        missionArray.forEach(m => {
          missionMap[m.name.toLowerCase()] = m;
          const opt = document.createElement('option');
          opt.value = m.name;

          if (m.available) {
            opt.textContent = m.name;
          } else {
            const needs = Array.isArray(m.requires_activation)
              ? m.requires_activation.join(', ')
              : '';
            opt.textContent = `${m.name} (locked: ${needs})`;
            opt.disabled = true;
            opt.style.opacity = 0.5;
          }

          missionSelect.appendChild(opt);
        });

      } catch (err) {
        console.error(err);
        missionSelect.innerHTML = '<option value="">Error loading missions</option>';
      }
    }

    // Load once on page load
    window.addEventListener('DOMContentLoaded', loadCapabilities);

    // === Drone icon & marker ===
    let DroneIcon = L.divIcon({
      className: '',
      iconSize: [40, 40],
      html: '<img id="drone-arrow" src="arrow-bluev2.png" class="rotating-drone">'
    });
    let droneMarker = L.marker([37.422, -122.084], { icon: DroneIcon }).addTo(map);

    // === Drawn shapes & setpoint ===
    let setpointMarker = null;
    let polygonLayer = null;
    let drawing = false;
    let followDrone = true;

    // === Leaflet-Draw setup ===
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({
      draw: {
        polyline: false,
        rectangle: false,
        circle: false,
        circlemarker: false,
        marker: false,
        polygon: {
          allowIntersection: false,
          showArea: true
        }
      },
      edit: {
        featureGroup: drawnItems
      }
    });
    map.addControl(drawControl);

    map.on('draw:created', function (e) {
      const layer = e.layer;
      if (e.layerType === 'polygon') {
        if (polygonLayer) drawnItems.removeLayer(polygonLayer);
        polygonLayer = layer;
        drawnItems.addLayer(layer);
      }
    });

    map.on('draw:drawstart', () => drawing = true);
    map.on('draw:drawstop', () => drawing = false);
    map.on('draw:editstart', () => drawing = true);
    map.on('draw:editstop', () => drawing = false);
    map.on('draw:deletestart', () => drawing = true);
    map.on('draw:deletestop', () => drawing = false);

    map.on("movestart", () => followDrone = false);

    map.on('click', function (e) {
      if (drawing) return;
      if (setpointMarker) map.removeLayer(setpointMarker);
      setpointMarker = L.marker(e.latlng).addTo(map);
    });

    // === Run the selected mission ===
    async function runMission() {
      const mission = missionSelect.value;
      if (!mission) return alert("Select a mission first.");

      const config = missionMap[mission.toLowerCase()];
      if (!config) return alert("Mission config not found.");

      let payload = { type: mission };

      if (config.geometry_type === "point") {
        if (!setpointMarker) return alert("Click on the map to set a target point.");
        const { lat, lng } = setpointMarker.getLatLng();
        payload.setpoint = { lat, lon: lng, alt: 12.0 };

      } else if (config.geometry_type === "polygon") {
        if (!polygonLayer) return alert("Draw a polygon first.");
        const latlngs = polygonLayer.getLatLngs()[0].map(p => ({ lat: p.lat, lon: p.lng }));
        payload.polygon = latlngs;
      }

      await fetch(`${apiHost}/run_mission`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    }


    // === Recenter camera on drone ===
    function recenter() {
      followDrone = true;
      if (droneMarker) {
        const pos = droneMarker.getLatLng();
        map.panTo([pos.lat, pos.lng]);
      }
    }

    // === Update drone marker from WS data ===
    function updateDroneMarker(data) {
      droneMarker.setLatLng([data.lat, data.lon]);
      if (followDrone) {
        map.panTo([data.lat, data.lon]);
      }
      document.getElementById("statusText").textContent = `Status: ${data.status}`;
      const arrowImg = document.getElementById("drone-arrow");
      if (arrowImg) {
        arrowImg.style.transform = `rotate(${data.heading}deg)`;
      }
    }

    // === WebSocket for live pose/status ===
    const ws = new WebSocket(`ws://${location.hostname}:8888/ws`);
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      updateDroneMarker(data);
    };
  </script>
</body>

</html>